USE polipiel;

-- Vista 1: Ventas Totales por Cliente
-- Esta vista muestra el total de ventas por cada cliente.

CREATE VIEW polipiel.ventas_totales_por_cliente AS
SELECT 
    c.id_cliente,
    c.nombre,
    c.apellido,
    SUM(v.total) AS total_ventas
FROM polipiel.cliente c
JOIN polipiel.venta v ON c.id_cliente = v.fk_cliente
GROUP BY c.id_cliente, c.nombre, c.apellido;
    
-- Vista 2: Ventas por Canal de Venta
-- Esta vista muestra las ventas totales agrupadas por cada canal de venta.

CREATE VIEW polipiel.ventas_por_canal AS
SELECT 
    cv.nombre_canal,
    COUNT(v.id_venta) AS cantidad_ventas,
    SUM(v.total) AS total_ventas
FROM polipiel.venta v
JOIN polipiel.canal_venta cv ON v.fk_canal = cv.id_canal
GROUP BY cv.nombre_canal;

----------------------------------------------------------

DROP FUNCTION IF EXISTS polipiel.fx_validar_email;
-- Function 1: Validar Formato de Email. Vamos a crear una funci칩n que valide si el email de un cliente est치 en el formato correcto.

DELIMITER //

CREATE FUNCTION polipiel.fx_validar_email(email VARCHAR(200))
RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE resultado BOOLEAN;
    SET resultado = (email REGEXP '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');
    RETURN resultado;
END //

DELIMITER ;

SELECT 
    nombre, 
    email, 
    polipiel.fx_validar_email(email) AS email_valido
FROM polipiel.cliente;



-- Function 2: Funci칩n para Validar Disponibilidad de Materiales. Esto puede ayudarte a prevenir situaciones donde intentes vender productos para los cuales no tienes suficientes materiales.

DROP FUNCTION IF EXISTS polipiel.fx_validar_stock_material;

DELIMITER //

CREATE FUNCTION polipiel.fx_validar_stock_material(fk_material INT, cantidad_requerida INT)
RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE disponible INT;
    SELECT cantidad_disponible INTO disponible 
    FROM stock_material 
    WHERE stock_material.fk_material = fk_material; -- Usamos el par치metro de entrada
    RETURN disponible >= cantidad_requerida; -- Verificamos si el stock es suficiente
END //

DELIMITER ;

SELECT 
    fk_material, 
    cantidad_requerida, 
    polipiel.fx_validar_stock_material(fk_material, cantidad_requerida) AS suficiente_stock
FROM polipiel.producto_material;



